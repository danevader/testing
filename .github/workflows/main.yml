name: Android Appium Test

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout Code
    - name: Checkout Code
      uses: actions/checkout@v2

    # Step 2: Set Up Java
    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        java-version: 17
        distribution: temurin

    # Step 3: Install Android SDK
    - name: Install Android SDK
      run: |
        mkdir -p $HOME/android-sdk/cmdline-tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip -O cmdline-tools.zip
        unzip -q cmdline-tools.zip -d $HOME/android-sdk/cmdline-tools
        mv $HOME/android-sdk/cmdline-tools/cmdline-tools $HOME/android-sdk/cmdline-tools/latest
        export ANDROID_HOME=$HOME/android-sdk
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$PATH
        yes | sdkmanager --licenses
        sdkmanager "platform-tools" "emulator" "cmdline-tools;latest" "system-images;android-30;google_apis;x86_64"

    # Step 4: Use Prebuilt AVD
    - name: Install and Start Emulator
      run: |
        export ANDROID_HOME=$HOME/android-sdk
        export PATH=$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
        echo "Using prebuilt AVD."
        sdkmanager --install "system-images;android-30;google_apis;x86_64"
        echo "hw.gpu.mode=swiftshader_indirect" > $HOME/.android/avd/Nexus6.avd/config.ini
        emulator -avd Nexus6 -no-snapshot -gpu off -no-boot-anim -accel off -verbose > emulator.log 2>&1 &
        adb wait-for-device || (echo "ADB could not find the emulator!" && cat emulator.log && exit 1)
        for i in {1..60}; do
          BOOT_COMPLETED=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
          if [ "$BOOT_COMPLETED" == "1" ]; then
            echo "Emulator is fully booted!"
            adb shell input keyevent 82 # Unlock screen
            break
          else
            echo "Waiting for emulator to boot... ($i/60)"
            sleep 10
          fi
        done
        if [ "$BOOT_COMPLETED" != "1" ]; then
          echo "Emulator failed to boot in time."
          exit 1
        fi

    # Step 5: Run Appium Tests
    - name: Run Appium Tests
      run: |
        mvn clean test -Dtest=newUserFlow.java
